{% extends "base-xyno.html" %}
{% block head2 %}
{% load custom_tags %}

<link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
<script type="text/javascript" src="//cdn.datatables.net/plug-ins/1.10.19/sorting/datetime-moment.js"></script>

<script type="text/javascript">


  function deleteOrder(billid) {
    var result = confirm("Are you sure you want to delete Bill #" + billid + "?");

    if (result) {
      stuff = {
        'status': 'Bill Cancelled',
        'csrfmiddlewaretoken': '{{ csrf_token }}'
      }
      $.ajax({
        type: "POST",
        url: "/cash-invoice/bill/" + billid + "/",
        data: stuff,
        success: function (data) {
          location.reload();
        }
      });
    }
  }


  function showmodal(id) {
    $.ajax({
      type: "GET",
      url: `https://dashboard.manxho.co.in/api/users/order/${id}/`,
      xhrFields: {
        withCredentials: true
      },
      dataType: "json",
      success: function (data) {
        // Create table headers
        var table = "<table>";
        // Get user info
        var user = data.user;
        var name = user.first_name + " " + user.last_name;
        var phone = data.shippingAddress.phone_number;
        var email = user.email;
        // Get order info
        var orderId = data.custom_order_id;
        var orderItems = data.orderItems;
        var price = data.totalPrice;
        var deliveryPrice = data.shippingPrice;
        var totalPrice = parseFloat(price) + parseFloat(deliveryPrice);
        // Create table rows
        var row = "<tr><td>Name:</td><td> " + name + "</td></tr><tr><td>Phone: </td><td> " + 
          phone + "</td></tr><tr><td>Email: </td><td> " + email + "</td></tr><tr><td>OrderId: </td><td> " + orderId + "</td></tr><tr><td>";
        for (var i = 0; i < orderItems.length; i++) {
          row += orderItems[i].name + " </td><td>  Rs. " + orderItems[i].price + "</td></tr>";
        }
        row += "</td></tr><tr><td>Item Price: </td><td> " + price + "</td></tr><tr><td>Delivery Price: </td><td> " + deliveryPrice + "</td></tr><tr><td>Total Price: </td><td> " + totalPrice + "</td></tr>";
        // Add rows to table
        table += row + "</table>";
        // Display table in modal
        $("#order-modal-body").html(table);
        $("#order-modal").modal("show");
      }
    });
  }

  $(document).ready(function () {

    $.fn.dataTable.moment('MMM DD, YYYY');
    $('#tblx').DataTable({
      'iDisplayLength': 500,
      "lengthMenu": [10, 25, 50, 75, 100, 500, 1000],
      'order': [
        [0, 'desc']
      ],
    });
  });


</script>

{% endblock %}

{% block maindiv %}

<h2>
  UPI Pending:
</h2>

<div>
  <table border="1" style="background-color: white;" id="tblx" class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>Order ID</th>
        <th>Date</th>
        <th>Customer</th>

        <th>Status</th>
        <th>Total Price</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for item in data %}

      <tr>
        <td>{{ item|pk }}</td>
        <td>{{ item.created_at }}</td>
        <td>{{ item.user.first_name }} {{ item.user.last_name }}</td>


        <td>UPI Unconfirmed</td>
        <td>{{ item.totalPrice }}</td>
        <td>
          <button class="btn btn-primary" onclick="showmodal({{ item|pk }})">Confirm Payment</button>
        </td>
      </tr>

      {% endfor %}
    </tbody>
  </table>

</div>


<!-- The Modal -->
<div class="modal" id="order-modal">
  <div class="modal-dialog">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header">
        <h4 class="modal-title">Edit Info</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>

      <!-- Modal body -->
      <div>
        <form id="form2" method="post">
          <div id="order-modal-body">

          </div>
        </form>

        <button type="button" class="btn btn-info rightp" onclick=submitform()>Submit</button>
      </div>

    </div>
  </div>
</div>
{% endblock %}